@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Admin Dashboard";

    var usersLast7Days = ViewData["UsersLast7Days"] as List<int>;
    var postsLast7Days = ViewData["PostsLast7Days"] as List<int>;
    var commentsLast7Days = ViewData["CommentsLast7Days"] as List<int>;
    var likesLast7Days = ViewData["LikesLast7Days"] as List<int>;

    Func<List<int>, string> calcDailyChange = (list) =>
    {
        if(list == null || list.Count < 2) return "N/A";
        int last = list[list.Count - 1];
        int prev = list[list.Count - 2];
        if (prev == 0) return "N/A";
        var change = ((double)(last - prev) / prev) * 100;
        var color = change >= 0 ? "green" : "red";
        var symbol = change >= 0 ? "▲" : "▼";
        return $"<span style='color:{color}; font-weight:600;'>{symbol} {Math.Abs(change):F1}%</span> vs yesterday";
    };

    string usersChange = calcDailyChange(usersLast7Days);
    string postsChange = calcDailyChange(postsLast7Days);
    string commentsChange = calcDailyChange(commentsLast7Days);
    string likesChange = calcDailyChange(likesLast7Days);
}

@section Styles{
    <style>
        :root {
            --bg-card: #fff;
            --shadow: 0 2px 6px rgba(0,0,0,0.1);
            --radius: 10px;
        }

        body {
            background: #f6f8fa;
        }


        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            padding: 10px 20px;
        }

        .widget-card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 25px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .widget-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .widget-card h4 {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .widget-card h2 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 6px;
        }


        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 10px 20px;
        }

        .chart-card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .chart-card h5 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #444;
        }


        .chart-card canvas {
            width: 100% !important;
            height: auto !important;
            max-width: 600px;
            margin: 0 auto;
        }

        @@media (max-width: 768px) {
            .widget-card h2 {
                font-size: 28px;
            }
            .chart-card canvas {
                max-width: 400px;
            }
        }

        @@media (max-width: 480px) {
            .widget-card h4 {
                font-size: 14px;
            }
            .widget-card h2 {
                font-size: 24px;
            }
            .chart-card h5 {
                font-size: 14px;
            }
            .chart-card canvas {
                max-width: 320px;
            }
        }
    </style>
}


<div class="dashboard-widgets">
    <div class="widget-card">
        <h4>Total Users</h4>
        <h2>@usersLast7Days.Last()</h2>
        <div>@Html.Raw(usersChange)</div>
    </div>
    <div class="widget-card">
        <h4>Total Posts</h4>
        <h2>@postsLast7Days.Last()</h2>
        <div>@Html.Raw(postsChange)</div>
    </div>
    <div class="widget-card">
        <h4>Total Comments</h4>
        <h2>@commentsLast7Days.Last()</h2>
        <div>@Html.Raw(commentsChange)</div>
    </div>
    <div class="widget-card">
        <h4>Total Likes</h4>
        <h2>@likesLast7Days.Last()</h2>
        <div>@Html.Raw(likesChange)</div>
    </div>
</div>

<div class="charts-container">
    <div class="chart-card">
        <h5>Users (Last 7 Days)</h5>
        <canvas id="usersChart"></canvas>
    </div>
    <div class="chart-card">
        <h5>Posts (Last 7 Days)</h5>
        <canvas id="postsChart"></canvas>
    </div>
    <div class="chart-card">
        <h5>Comments (Last 7 Days)</h5>
        <canvas id="commentsChart"></canvas>
    </div>
    <div class="chart-card">
        <h5>Likes (Last 7 Days)</h5>
        <canvas id="likesChart"></canvas>
    </div>
</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const usersData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(usersLast7Days));
        const postsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(postsLast7Days));
        const commentsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(commentsLast7Days));
        const likesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(likesLast7Days));

        const days = ["Day -6","Day -5","Day -4","Day -3","Day -2","Yesterday","Today"];

        function renderBarChart(id, label, data, color="#0095f6"){
            new Chart(document.getElementById(id), {
                type: 'bar',
                data: { labels: days, datasets: [{ label: label, data: data, backgroundColor: color }] },
                options: { responsive:true, plugins:{ legend:{display:false}, title:{display:true,text:label} } }
            });
        }

        function renderLineChart(id, label, data, color="#0095f6"){
            new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '33',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive:true, plugins:{ legend:{display:false}, title:{display:true,text:label} } }
            });
        }

        renderBarChart('usersChart','Users',usersData);
        renderBarChart('postsChart','Posts',postsData,'#28a745');

        renderLineChart('commentsChart','Comments',commentsData,'#ffc107');
        renderLineChart('likesChart','Likes',likesData,'#e0245e');
    </script>
}
